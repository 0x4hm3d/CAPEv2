
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Processing Modules &#8212; CAPE Sandbox v2.1 Book</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Signatures" href="signatures.html" />
    <link rel="prev" title="Analysis Packages" href="packages.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="signatures.html" title="Signatures"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="packages.html" title="Analysis Packages"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CAPE Sandbox v2.1 Book</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Customization</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Processing Modules</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="processing-modules">
<h1>Processing Modules<a class="headerlink" href="#processing-modules" title="Permalink to this headline">¶</a></h1>
<p>CAPE’s processing modules are Python scripts that let you define custom
ways to analyze the raw results generated by the sandbox and append
some information to a global container that will be later used by the
signatures and the reporting modules.</p>
<p>You can create as many modules as you want, as long as they follow a
predefined structure that we will present in this chapter.</p>
<section id="global-container">
<h2>Global Container<a class="headerlink" href="#global-container" title="Permalink to this headline">¶</a></h2>
<p>After an analysis is completed, CAPE will invoke all the processing
modules available in the <em>modules/processing/</em> directory. Any additional
module you decide to create must be placed inside that directory.</p>
<p>Every module should also have a dedicated section in the file <em>conf/processing.conf</em>: for
example, if you create a module <em>module/processing/foobar.py</em> you will have to append
the following section to <em>conf/processing.conf</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">foobar</span><span class="p">]</span>
<span class="n">enabled</span> <span class="o">=</span> <span class="n">on</span>
</pre></div>
</div>
<p>Every module will then be initialized and executed and the data returned
will be appended in a data structure that we’ll call <strong>global container</strong>.</p>
<p>This container is simply just a big Python dictionary that includes
the abstracted results produced by all the modules classified by their
identification key.</p>
<p>CAPE already provides a default set of modules that will
generate a <em>standard</em> global container. It’s important for the existing
reporting modules (HTML report etc.) that these default modules are
not modified, otherwise, the resulting global container structure would
change and the reporting modules wouldn’t be able to recognize it and
extract the information used to build the final reports.</p>
<dl class="simple">
<dt>The currently available default processing modules are:</dt><dd><ul class="simple">
<li><p><strong>AnalysisInfo</strong> <em>(modules/processing/analysisinfo.py)</em> - generates some basic information on the current analysis, such as timestamps, version of CAPE, and so on.</p></li>
<li><p><strong>BehaviorAnalysis</strong> <em>(modules/processing/behavior.py)</em> - parses the raw behavioral logs and perform some initial transformations and interpretations, including the complete processes tracing, a behavioral summary, and a process tree.</p></li>
<li><p><strong>Debug</strong> <em>(modules/processing/debug.py)</em> - includes errors and the <em>analysis.log</em> generated by the analyzer.</p></li>
<li><p><strong>Dropped</strong> <em>(modules/processing/dropped.py)</em> - includes information on the files dropped by the malware and dumped by CAPE.</p></li>
<li><p><strong>Memory</strong> <em>(modules/processing/memory.py)</em> - executes Volatility on a full memory dump.</p></li>
<li><p><strong>NetworkAnalysis</strong> <em>(modules/processing/network.py)</em> - parses the PCAP file and extracts some network information, such as DNS traffic, domains, IPs, HTTP requests, IRC, and SMTP traffic.</p></li>
<li><p><strong>ProcMemory</strong> <em>(modules/processing/procmemory.py)</em> - performs analysis of process memory dump. <strong>Note</strong>: the module can process user-defined Yara rules from data/yara/memory/index_memory.yar. Just edit this file to add your Yara rules.</p></li>
<li><p><strong>StaticAnalysis</strong> <em>(modules/processing/static.py)</em> - performs some static analysis of PE32 files.</p></li>
<li><p><strong>Strings</strong> <em>(modules/processing/strings.py)</em> - extracts strings from the analyzed binary.</p></li>
<li><p><strong>TargetInfo</strong> <em>(modules/processing/targetinfo.py)</em> - includes information on the analyzed file, such as hashes.</p></li>
<li><p><strong>VirusTotal</strong> <em>(modules/processing/virustotal.py)</em> - searches on VirusTotal.com for antivirus signatures of the analyzed file. <strong>Note</strong>: the file is not uploaded on VirusTotal.com, if the file was not previously uploaded on the website no results will be retrieved.</p></li>
</ul>
</dd>
</dl>
</section>
<section id="getting-started">
<h2>Getting started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<p>To make them available to CAPE, all processing modules must be
placed inside the folder at <em>modules/processing/</em>.</p>
<p>A basic processing module could look like this:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kn">from</span> <span class="nn">lib.cuckoo.common.abstracts</span> <span class="kn">import</span> <span class="n">Processing</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="k">class</span> <span class="nc">MyModule</span><span class="p">(</span><span class="n">Processing</span><span class="p">):</span>
<span class="linenos">4</span>
<span class="linenos">5</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">6</span>        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;key&quot;</span>
<span class="linenos">7</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">do_something</span><span class="p">()</span>
<span class="linenos">8</span>        <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div></blockquote>
<dl class="simple">
<dt>Every processing module should contain:</dt><dd><ul class="simple">
<li><p>A class inheriting <code class="docutils literal notranslate"><span class="pre">Processing</span></code>.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">run()</span></code> function.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">self.key</span></code> attribute defining the name to be used as a sub-container for the returned data.</p></li>
<li><p>A set of data (list, dictionary, string, etc.) will be appended to the global container.</p></li>
</ul>
</dd>
</dl>
<p>You can also specify an <code class="docutils literal notranslate"><span class="pre">order</span></code> value, which allows you to run the available processing modules in
an ordered sequence. By default, all modules are set with an <code class="docutils literal notranslate"><span class="pre">order</span></code> value of <code class="docutils literal notranslate"><span class="pre">1</span></code> and are executed
in alphabetical order.</p>
<p>If you want to change this value your module would look like this:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kn">from</span> <span class="nn">lib.cuckoo.common.abstracts</span> <span class="kn">import</span> <span class="n">Processing</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="k">class</span> <span class="nc">MyModule</span><span class="p">(</span><span class="n">Processing</span><span class="p">):</span>
<span class="linenos">4</span>    <span class="n">order</span> <span class="o">=</span> <span class="mi">2</span>
<span class="linenos">5</span>
<span class="linenos">6</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">7</span>        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;key&quot;</span>
<span class="linenos">8</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">do_something</span><span class="p">()</span>
<span class="linenos">9</span>        <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div></blockquote>
<p>You can also manually disable a processing module by setting the <code class="docutils literal notranslate"><span class="pre">enabled</span></code> attribute to <code class="docutils literal notranslate"><span class="pre">False</span></code>:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kn">from</span> <span class="nn">lib.cuckoo.common.abstracts</span> <span class="kn">import</span> <span class="n">Processing</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="k">class</span> <span class="nc">MyModule</span><span class="p">(</span><span class="n">Processing</span><span class="p">):</span>
<span class="linenos">4</span>    <span class="n">enabled</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">5</span>
<span class="linenos">6</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">7</span>        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;key&quot;</span>
<span class="linenos">8</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">do_something</span><span class="p">()</span>
<span class="linenos">9</span>        <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div></blockquote>
<p>The processing modules are provided with some attributes that can be used to access the raw results
for the given analysis:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">self.analysis_path</span></code>: path to the folder containing the results (e.g. <em>storage/analysis/1</em>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.log_path</span></code>: path to the <em>analysis.log</em> file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.conf_path</span></code>: path to the <em>analysis.conf</em> file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.file_path</span></code>: path to the analyzed file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.dropped_path</span></code>: path to the folder containing the dropped files.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.logs_path</span></code>: path to the folder containing the raw behavioral logs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.shots_path</span></code>: path to the folder containing the screenshots.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.pcap_path</span></code>: path to the network pcap dump.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.memory_path</span></code>: path to the full memory dump, if created.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.pmemory_path</span></code>: path to the process memory dumps, if created.</p></li>
</ul>
</div></blockquote>
<p>With these attributes, you should be able to easily access all the raw results stored by CAPE and
perform your analytic operations on them.</p>
<p>As a last note, a good practice is to use the <code class="docutils literal notranslate"><span class="pre">CuckooProcessingError</span></code> exception
whenever the module encounters an issue you want to report to CAPE.
This can be done by importing the class like this:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">lib.cuckoo.common.exceptions</span> <span class="kn">import</span> <span class="n">CuckooProcessingError</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">lib.cuckoo.common.abstracts</span> <span class="kn">import</span> <span class="n">Processing</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">class</span> <span class="nc">MyModule</span><span class="p">(</span><span class="n">Processing</span><span class="p">):</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 7</span>        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;key&quot;</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">10</span>            <span class="n">data</span> <span class="o">=</span> <span class="n">do_something</span><span class="p">()</span>
<span class="linenos">11</span>        <span class="k">except</span> <span class="n">SomethingFailed</span><span class="p">:</span>
<span class="linenos">12</span>            <span class="k">raise</span> <span class="n">CuckooProcessingError</span><span class="p">(</span><span class="s2">&quot;Failed&quot;</span><span class="p">)</span>
<span class="linenos">13</span>
<span class="linenos">14</span>        <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/cape.png" alt="Logo"/>
            </a></p>
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Processing Modules</a><ul>
<li><a class="reference internal" href="#global-container">Global Container</a></li>
<li><a class="reference internal" href="#getting-started">Getting started</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="packages.html"
                          title="previous chapter">Analysis Packages</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="signatures.html"
                          title="next chapter">Signatures</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/customization/processing.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="signatures.html" title="Signatures"
             >next</a></li>
        <li class="right" >
          <a href="packages.html" title="Analysis Packages"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CAPE Sandbox v2.1 Book</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Customization</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Processing Modules</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2010-2015, Cuckoo Foundation, 2016-2020, kevoreilly.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>